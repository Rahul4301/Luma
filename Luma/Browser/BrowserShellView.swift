// Luma MVP - autogenerated by Cursor
import SwiftUI
import WebKit

/// Minimal browser shell hosting a WKWebView via WebViewWrapper and TabManager.
///
/// Per SRS: WebKit-only renderer, minimal tab UI, address bar.
/// Per SECURITY.md: No JS message handlers, no HTML scraping.
struct BrowserShellView: View {
    @StateObject private var tabManager = TabManager()
    @StateObject private var webViewWrapper = WebViewWrapper()
    @State private var addressBarText: String = "https://example.com"
    
    var body: some View {
        VStack(spacing: 0) {
            // Top bar: address field + Go button
            HStack {
                TextField("Enter URL", text: $addressBarText, onCommit: goToAddress)
                    .textFieldStyle(.roundedBorder)
                Button("Go") {
                    goToAddress()
                }
            }
            .padding()
            
            // Web content
            WebViewContainer(webViewWrapper: webViewWrapper)
                .frame(maxWidth: .infinity, maxHeight: .infinity)
        }
        .onAppear {
            // On first launch, create a tab and load https://example.com
            if tabManager.currentTab == nil {
                if let url = URL(string: "https://example.com") {
                    _ = tabManager.newTab(url: url)
                    webViewWrapper.load(url: url)
                    addressBarText = url.absoluteString
                }
            } else if let currentId = tabManager.currentTab,
                      let url = tabManager.tabs[currentId] {
                addressBarText = url.absoluteString
                webViewWrapper.load(url: url)
            }
        }
    }
    
    /// Normalizes and navigates to the URL in the address bar.
    private func goToAddress() {
        let trimmed = addressBarText.trimmingCharacters(in: .whitespacesAndNewlines)
        guard !trimmed.isEmpty else { return }
        
        let normalized: String
        if trimmed.contains("://") {
            normalized = trimmed
        } else {
            normalized = "https://" + trimmed
        }
        
        guard let url = URL(string: normalized) else {
            return
        }
        
        if tabManager.currentTab == nil {
            _ = tabManager.newTab(url: url)
        } else {
            tabManager.navigateCurrentTab(to: url)
        }
        
        webViewWrapper.load(url: url)
        addressBarText = normalized
    }
}

/// SwiftUI host for WKWebView using the existing WebViewWrapper.
struct WebViewContainer: NSViewRepresentable {
    let webViewWrapper: WebViewWrapper
    
    func makeNSView(context: Context) -> WKWebView {
        // Use the WKWebView managed by WebViewWrapper.
        webViewWrapper.view
    }
    
    func updateNSView(_ nsView: WKWebView, context: Context) {
        // No-op: navigation is driven explicitly via WebViewWrapper.load(url:).
    }
}

#Preview {
    BrowserShellView()
}
